apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gitlab.runner.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gitlab.runner.labels" . | nindent 4 }}
data:
  config.toml: |
    concurrent = {{ .Values.runner.concurrent }}
    check_interval = 10
    listen_address = "0.0.0.0:9252"

  entrypoint.sh: |
    #!/bin/bash

    set -xe

    cp /scripts/config.toml /etc/gitlab-runner/

    # Register the runner
    /entrypoint register \
        --non-interactive \
    {{ if .Values.runner.runUntagged -}}
        --run-untagged \
    {{- end }}
        --registration-token "{{ .Values.runner.token }}" \
        --url "https://{{ .Values.server.subdomain }}.{{ .Values.global.domainName }}" \
        --clone-url "https://{{ .Values.server.subdomain }}.{{ .Values.global.domainName }}" \
        --executor "kubernetes" \
        --name "Kubernetes Runner" \
        --kubernetes-image "{{ .Values.runner.defaultImage }}" \
        --tag-list "{{ .Values.runner.tags }}" \
        --kubernetes-node-selector {{ .Values.runner.jobNodeSelector }} \
        --config "/etc/gitlab-runner/config.toml"

    # Start the runner
    /entrypoint run --user=gitlab-runner \
        --working-directory=/home/gitlab-runner \
        --config "/etc/gitlab-runner/config.toml"

