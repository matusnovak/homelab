---
- name: Create Signal bridge folder
  become: yes
  file:
    path: "{{ data_dir }}/data/matrix/bridges/signal"
    state: directory
    mode: 0755
    owner: "1337"
    group: "1337"
    recurse: no

- name: Create Signal bridge database
  docker_script:
    docker:
      host: "{{ docker.host }}"
    network: "{{ docker_network.name }}"
    image: "{{ scriptrunner.id }}"
    script: "/tmp/postgres.py"
    args:
      - "create"
      - |
        {
          "host": "{{ container_postgres.alias }}",
          "user": "postgres",
          "password": "{{ passwords.postgres_admin }}",
          "database": "postgres",
          "port": 5432,
          "create": {
            "database": {
              "name": "matrix_signal",
              "extra": "ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' template=template0"
            },
            "user": {
              "name": "matrix_signal",
              "password": "{{ passwords.matrix_signal_database }}",
              "database": "matrix_signal"
            }
          }
        }

- name: Check Signal bridge config
  become: yes
  stat:
    path: "{{ data_dir }}/data/matrix/bridges/signal/config.yaml"
  register: "matrix_signal_config_file"

- name: Create Signal bridge config
  become: yes
  template:
    src: "roles/matrix/files/bridges/signal/{{item}}.j2"
    dest: "{{ data_dir }}/data/matrix/bridges/signal/{{item}}"
    owner: "1337"
    group: "1337"
  loop:
    - "config.yaml"
  register: "matrix_signal_config"
  when: not matrix_signal_config_file.stat.exists

- name: Deploy Signal bridge
  docker_deploy:
    host: "{{ docker.host }}"
    project: "{{ project_name }}"
    container:
      image: "{{ images.matrix_signal }}"
      name: "matrix_signal"
      networks:
        - name: "{{ docker_network.name }}"
          alias: "signalbridge"
      volumes:
        - host: "{{ data_dir }}/data/matrix/bridges/signal"
          guest: "/data"
          read_only: false
          mode: "z"
  register: container_matrix_signal
